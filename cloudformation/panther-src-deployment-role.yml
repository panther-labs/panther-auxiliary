# Copyright (C) 2022 Panther Labs, Inc.
#
# The Panther SaaS is licensed under the terms of the Panther Enterprise Subscription
# Agreement available at https://panther.com/enterprise-subscription-agreement/.
# All intellectual property rights in and to the Panther SaaS, including any and all
# rights to access the Panther SaaS, are governed by the Panther Enterprise Subscription Agreement.

AWSTemplateFormatVersion: 2010-09-09
Description: IAM role for deploying Panther from source

Parameters:
  DeploymentRoleName:
    Type: String
    Description: Name of the deployment IAM role. If an empty string, the name will be autogenerated
    Default: PantherDeploymentRole
  IdentityAccountId:
    Type: String
    Description: The account ID for the account the deployment role will be assumed from
    Default: ''

Conditions:
  AccountSpecified: !Not [!Equals [!Ref IdentityAccountId, '']]
  RoleNameSpecified: !Not [!Equals [!Ref DeploymentRoleName, '']]

Resources:
  DeploymentRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If [RoleNameSpecified, !Ref DeploymentRoleName, !Ref AWS::NoValue]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !If
                - AccountSpecified
                - !Sub arn:${AWS::Partition}:iam::${IdentityAccountId}:root
                - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:root
            Action: sts:AssumeRole
            Condition:
              Bool:
                aws:SecureTransport: true
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              Bool:
                aws:SecureTransport: true
      Description: IAM role for deploying Panther
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSCloudFormationReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSLambda_ReadOnlyAccess
      Policies:
        - PolicyName: PantherSourceDeploy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:*
                  - codebuild:List*
                  - ecr:GetAuthorizationToken
                  - kms:Describe*
                  - kms:List*
                  - logs:*
                  - secretsmanager:List*
                Resource: '*'
              - Effect: Allow
                Action: cloudformation:*
                Resource:
                  - !Sub arn:${AWS::Partition}:cloudformation:*:${AWS::AccountId}:stack/panther*
                  - !Sub arn:${AWS::Partition}:cloudformation:*:${AWS::AccountId}:stackset/panther*
                  - !Sub arn:${AWS::Partition}:cloudformation:*:aws:transform/Serverless-2016-10-31
              - Effect: Allow
                Action: codebuild:*
                Resource: !Sub arn:${AWS::Partition}:codebuild:*:${AWS::AccountId}:project/panther-pulumi
              - Effect: Allow
                Action: ecr:*
                Resource: !Sub arn:${AWS::Partition}:ecr:*:${AWS::AccountId}:repository/panther-web-dev
              - Effect: Allow
                Action: iam:*
                Resource: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/PantherDevDeploymentRole-*
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource: !Sub arn:${AWS::Partition}:lambda:*:${AWS::AccountId}:function:panther-users-api
              - Effect: Allow
                Action: s3:*
                Resource: !Sub arn:${AWS::Partition}:s3:::panther-dev-sourcebucket-*
              - Effect: Allow
                Action: secretsmanager:*
                Resource: !Sub arn:${AWS::Partition}:secretsmanager:*:${AWS::AccountId}:secret:panther*
              - Effect: Allow
                Action:
                  - iam:AttachRolePolicy
                  - iam:CreateRole
                  - iam:DeleteRole
                  - iam:DeleteRolePolicy
                  - iam:DetachRolePolicy
                  - iam:GetRole
                  - iam:GetRolePolicy
                  - iam:PutRolePolicy
                  - iam:UpdateAssumeRolePolicy
                  - iam:UpdateRole
                  - iam:UpdateRoleDescription
                  - iam:ListRoleTags
                  - iam:TagRole
                  - iam:UntagRole
                Resource:
                  - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/panther-*
                  - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/Panther*

      Tags:
        - Key: panther:app
          Value: panther

Outputs:
  DeploymentRoleArn:
    Value: !GetAtt DeploymentRole.Arn
