# Copyright (C) 2022 Panther Labs Inc
#
# Panther Enterprise is licensed under the terms of a commercial license available from
# Panther Labs Inc ("Panther Commercial License") by contacting contact@runpanther.com.
# All use, distribution, and/or modification of this software, whether commercial or non-commercial,
# falls under the Panther Commercial License to the extent it is permitted.

AWSTemplateFormatVersion: 2010-09-09
Description: IAM role for deploying Panther from source

Parameters:
  DeploymentRoleName:
    Type: String
    Description: Name of the deployment IAM role. If an empty string, the name will be autogenerated
    Default: PantherDeploymentRole
  IdentityAccountId:
    Type: String
    Description: The account ID for the account the deployment role will be assumed from
    Default: ''

Conditions:
  AccountSpecified: !Not [!Equals [!Ref IdentityAccountId, '']]
  RoleNameSpecified: !Not [!Equals [!Ref DeploymentRoleName, '']]

Resources:
  DeploymentRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If [RoleNameSpecified, !Ref DeploymentRoleName, !Ref AWS::NoValue]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !If
                - AccountSpecified
                - !Sub arn:${AWS::Partition}:iam::${IdentityAccountId}:root
                - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:root
            Action: sts:AssumeRole
            Condition:
              Bool:
                aws:SecureTransport: true
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              Bool:
                aws:SecureTransport: true
      Description: IAM role for deploying Panther
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSCloudFormationReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSLambda_ReadOnlyAccess
      Policies:
        - PolicyName: PantherSourceDeploy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:*
                  - codebuild:List*
                  - ecr:GetAuthorizationToken
                  - kms:Describe*
                  - kms:List*
                  - logs:*
                  - secretsmanager:List*
                Resource: '*'
              - Effect: Allow
                Action: cloudformation:*
                Resource:
                  - !Sub arn:${AWS::Partition}:cloudformation:*:${AWS::AccountId}:stack/panther*
                  - !Sub arn:${AWS::Partition}:cloudformation:*:${AWS::AccountId}:stackset/panther*
                  - !Sub arn:${AWS::Partition}:cloudformation:*:aws:transform/Serverless-2016-10-31
              - Effect: Allow
                Action: codebuild:*
                Resource: !Sub arn:${AWS::Partition}:codebuild:*:${AWS::AccountId}:project/panther-pulumi
              - Effect: Allow
                Action: ecr:*
                Resource: !Sub arn:${AWS::Partition}:ecr:*:${AWS::AccountId}:repository/panther-web-dev
              - Effect: Allow
                Action: iam:*
                Resource: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/PantherDevDeploymentRole-*
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource: !Sub arn:${AWS::Partition}:lambda:*:${AWS::AccountId}:function:panther-users-api
              - Effect: Allow
                Action: s3:*
                Resource: !Sub arn:${AWS::Partition}:s3:::panther-dev-sourcebucket-*
              - Effect: Allow
                Action: secretsmanager:*
                Resource: !Sub arn:${AWS::Partition}:secretsmanager:*:${AWS::AccountId}:secret:panther*
      Tags:
        - Key: Application
          Value: Panther

Outputs:
  DeploymentRoleArn:
    Value: !GetAtt DeploymentRole.Arn
