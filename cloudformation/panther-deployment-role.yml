# Copyright (C) 2020 Panther Labs Inc
#
# Panther Enterprise is licensed under the terms of a commercial license available from
# Panther Labs Inc ("Panther Commercial License") by contacting contact@runpanther.com.
# All use, distribution, and/or modification of this software, whether commercial or non-commercial,
# falls under the Panther Commercial License to the extent it is permitted.

AWSTemplateFormatVersion: 2010-09-09
Description: IAM role for deploying Panther

Parameters:
  DeploymentRoleName:
    Type: String
    Description: Name of the deployment IAM role. If an empty string, the name will be autogenerated
    Default: PantherDeploymentRole
  IdentityAccountId:
    Type: String
    Description: The account ID for the account the deployment role will be assumed from
    Default: ''

Conditions:
  AccountSpecified: !Not [!Equals [!Ref IdentityAccountId, '']]
  RoleNameSpecified: !Not [!Equals [!Ref DeploymentRoleName, '']]

Resources:
  DeploymentRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If [RoleNameSpecified, !Ref DeploymentRoleName, !Ref AWS::NoValue]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !If
                - AccountSpecified
                - !Sub arn:${AWS::Partition}:iam::${IdentityAccountId}:root
                - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:root
            Action: sts:AssumeRole
            Condition:
              Bool:
                aws:SecureTransport: true
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              Bool:
                aws:SecureTransport: true
      Description: IAM role for deploying Panther
      Tags:
        - Key: Application
          Value: Panther

  DeploymentPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: PantherDeployment
      Roles:
        - !Ref DeploymentRole
      PolicyDocument:
        # 'mage fmt' will copy this policy document into ../terraform/panther_deployment_role/main.tf
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: # permissions which can't be restricted to specific resources
              - acm:*
              - apigateway:*
              - application-autoscaling:DeleteScalingPolicy
              - application-autoscaling:DeregisterScalableTarget
              - application-autoscaling:DescribeScalingPolicies
              - application-autoscaling:DescribeScalableTargets
              - application-autoscaling:PutScalingPolicy
              - application-autoscaling:RegisterScalableTarget
              - appsync:*
              - athena:*
              - cloudformation:Describe*
              - cloudformation:List*
              - cloudtrail:DescribeTrails
              - cloudtrail:CreateTrail
              - cloudwatch:*
              - cognito-idp:*
              - dynamodb:List*
              - ec2:AllocateAddress
              - ec2:AssociateRouteTable
              - ec2:AssociateSubnetCidrBlock
              - ec2:AssociateVpcCidrBlock
              - ec2:AuthorizeSecurityGroupEgress
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:AttachInternetGateway
              - ec2:CreateVpcEndpoint
              - ec2:CreateFlowLogs
              - ec2:CreateInternetGateway
              - ec2:CreateNatGateway
              - ec2:CreateRoute
              - ec2:CreateRouteTable
              - ec2:CreateSecurityGroup
              - ec2:CreateSubnet
              - ec2:CreateTags
              - ec2:CreateVpc
              - ec2:DeleteVpcEndpoints
              - ec2:DeleteVpcEndpoint
              - ec2:DeleteFlowLogs
              - ec2:DeleteInternetGateway
              - ec2:DeleteNatGateway
              - ec2:DeleteRoute
              - ec2:DeleteRouteTable
              - ec2:DeleteSecurityGroup
              - ec2:DeleteSubnet
              - ec2:DeleteTags
              - ec2:DeleteVpc
              - ec2:Describe*
              - ec2:DetachInternetGateway
              - ec2:DisassociateAddress
              - ec2:DisassociateRouteTable
              - ec2:DisassociateSubnetCidrBlock
              - ec2:ModifySubnetAttribute
              - ec2:ModifyVpcAttribute
              - ec2:ModifyVpcEndpoint
              - ec2:ReleaseAddress
              - ec2:ReplaceRoute
              - ec2:ReplaceRouteTableAssociation
              - ec2:RevokeSecurityGroupEgress
              - ec2:RevokeSecurityGroupIngress
              - ec2:UpdateSecurityGroupRuleDescriptionsEgress
              - ec2:UpdateSecurityGroupRuleDescriptionsIngress
              - elasticfilesystem:ClientMount
              - elasticfilesystem:ClientRootAccess
              - elasticfilesystem:ClientWrite
              - elasticfilesystem:CreateAccessPoint
              - elasticfilesystem:CreateFileSystem
              - elasticfilesystem:CreateMountTarget
              - elasticfilesystem:DeleteAccessPoint
              - elasticfilesystem:DeleteFileSystem
              - elasticfilesystem:DeleteMountTarget
              - elasticfilesystem:DescribeAccessPoints
              - elasticfilesystem:DescribeFileSystems
              - elasticfilesystem:DescribeFileSystemPolicy
              - elasticfilesystem:DescribeLifecycleConfiguration
              - elasticfilesystem:DescribeMountTargets
              - elasticfilesystem:PutLifecycleConfiguration
              - elasticfilesystem:PutFileSystemPolicy
              - elasticfilesystem:ListTagsForResource
              - elasticfilesystem:TagResource
              - elasticfilesystem:UntagResource
              - elasticloadbalancing:*
              - ecr:GetAuthorizationToken
              - ecs:*
              - events:*
              - firehose:DescribeDeliveryStream
              - firehose:CreateDeliveryStream
              - firehose:DeleteDeliveryStream
              - firehose:ListDeliveryStreams
              - glue:*
              - guardduty:CreatePublishingDestination
              - guardduty:ListDetectors
              - kms:CreateKey
              - kms:List*
              - lambda:*EventSourceMapping
              - lambda:List*
              - logs:*
              - s3:ListAllMyBuckets
              - sns:List*
              - sqs:List*
              - states:CreateStateMachine
              - states:TagResource
              - states:UntagResource
            Resource: '*'
          - Effect: Allow
            Action: # permissions for handling self-onboarding CloudTrail
              - cloudtrail:AddTags
              - cloudtrail:DeleteTrail
              - cloudtrail:PutEventSelectors
              - cloudtrail:StartLogging
              - cloudtrail:StopLogging
              - cloudtrail:UpdateTrail
            Resource: !Sub arn:${AWS::Partition}:cloudtrail:*:${AWS::AccountId}:trail/panther-cloudtrail-*
          - Effect: Allow
            Action: cloudformation:*
            Resource:
              - !Sub arn:${AWS::Partition}:cloudformation:*:${AWS::AccountId}:stack/panther*
              - !Sub arn:${AWS::Partition}:cloudformation:*:${AWS::AccountId}:stackset/panther*
          - Effect: Allow # for ddb athena connector
            Action: cloudformation:*
            Resource: !Sub arn:${AWS::Partition}:cloudformation:*:aws:transform/Serverless-2016-10-31
          - Effect: Allow # for ddb athena connector
            Action: serverlessrepo:*
            Resource: !Sub arn:${AWS::Partition}:serverlessrepo:*:*:applications/*
          - Effect: Allow # for ddb athena connector
            Action:
              - lambda:GetFunction
              - lambda:CreateFunction
            Resource: !Sub arn:${AWS::Partition}:lambda:*:${AWS::AccountId}:function:ddb
          - Effect: Allow # for ddb athena connector
            Action: s3:GetObject
            Resource: !Sub arn:${AWS::Partition}:s3:::awsserverlessrepo-changesets-*
          - Effect: Allow
            Action: dynamodb:*
            Resource: !Sub arn:${AWS::Partition}:dynamodb:*:${AWS::AccountId}:table/panther-*
          - Effect: Allow
            Action: ecr:*
            Resource: !Sub arn:${AWS::Partition}:ecr:*:${AWS::AccountId}:repository/panther-*
          - Effect: Allow
            Action: execute-api:Invoke
            Resource: !Sub arn:${AWS::Partition}:execute-api:*:${AWS::AccountId}:*
          - Effect: Allow
            Action: firehose:*
            Resource: !Sub arn:${AWS::Partition}:firehose:*:${AWS::AccountId}:deliverystream/panther-*
          - Effect: Allow
            Action: iam:*
            Resource:
              - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/AWSServiceRole*
              - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-service-role/*
              - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/panther-*
              - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/Panther*
              - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:server-certificate/panther/*
          - Effect: Allow
            Action: kms:*
            Resource:
              - !Sub arn:${AWS::Partition}:kms:*:${AWS::AccountId}:alias/panther-*
              - !Sub arn:${AWS::Partition}:kms:*:${AWS::AccountId}:key/*
          - Effect: Allow
            Action: lambda:*
            Resource:
              - !Sub arn:${AWS::Partition}:lambda:*:${AWS::AccountId}:event-source-mapping:*
              - !Sub arn:${AWS::Partition}:lambda:*:${AWS::AccountId}:function:panther-*
              - !Sub arn:${AWS::Partition}:lambda:*:${AWS::AccountId}:layer:panther-*

              # Panther v1.14 unintentionally introduced a Lambda function named "ddb."
              # v1.15 renamed the function so it has the conventional "panther-" prefix.
              #
              # The deployment role needs to be able to delete the "ddb" function
              # until all accounts have migrated to v1.15+. Otherwise, the migration will fail.
              - !Sub arn:${AWS::Partition}:lambda:*:${AWS::AccountId}:function:ddb
          - Effect: Allow
            Action: s3:*
            Resource: !Sub arn:${AWS::Partition}:s3:::panther-*
          - Effect: Allow
            Action: sns:*
            Resource: !Sub arn:${AWS::Partition}:sns:*:${AWS::AccountId}:panther-*
          - Effect: Allow
            Action: sqs:*
            Resource: !Sub arn:${AWS::Partition}:sqs:*:${AWS::AccountId}:panther-*
          - Effect: Allow
            Action: states:*
            Resource:
              - !Sub arn:${AWS::Partition}:states:*:${AWS::AccountId}:activity:panther-*
              - !Sub arn:${AWS::Partition}:states:*:${AWS::AccountId}:execution:panther-*:*
              - !Sub arn:${AWS::Partition}:states:*:${AWS::AccountId}:stateMachine:panther-*

Outputs:
  DeploymentRoleArn:
    Value: !GetAtt DeploymentRole.Arn
