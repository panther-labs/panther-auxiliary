# Copyright (C) 2022 Panther Labs Inc
#
# Panther Enterprise is licensed under the terms of a commercial license available from
# Panther Labs Inc ("Panther Commercial License") by contacting contact@runpanther.com.
# All use, distribution, and/or modification of this software, whether commercial or non-commercial,
# falls under the Panther Commercial License to the extent it is permitted.

AWSTemplateFormatVersion: 2010-09-09
Description: IAM role for deploying Panther

Parameters:
  DeploymentRoleName:
    Type: String
    Description: Name of the deployment IAM role. If an empty string, the name will be autogenerated
    Default: PantherDeploymentRole
  IdentityAccountId:
    Type: String
    Description: The account ID for the account the deployment role will be assumed from
    Default: ''

Conditions:
  AccountSpecified: !Not [!Equals [!Ref IdentityAccountId, '']]
  RoleNameSpecified: !Not [!Equals [!Ref DeploymentRoleName, '']]

Resources:
  DeploymentRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If [RoleNameSpecified, !Ref DeploymentRoleName, !Ref AWS::NoValue]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !If
                - AccountSpecified
                - !Sub arn:${AWS::Partition}:iam::${IdentityAccountId}:root
                - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:root
            Action: sts:AssumeRole
            Condition:
              Bool:
                aws:SecureTransport: true
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              Bool:
                aws:SecureTransport: true
      Description: IAM role for deploying Panther
      Tags:
        - Key: Application
          Value: Panther

  DeploymentPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: PantherDeployment
      Roles:
        - !Ref DeploymentRole
      PolicyDocument:
        # 'mage fmt' will copy this policy document into ../terraform/panther_deployment_role/main.tf
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: # permissions which can't be restricted to specific resources
              - acm:*
              - apigateway:*
              - application-autoscaling:DeleteScalingPolicy
              - application-autoscaling:DeregisterScalableTarget
              - application-autoscaling:DescribeScalingPolicies
              - application-autoscaling:DescribeScalableTargets
              - application-autoscaling:PutScalingPolicy
              - application-autoscaling:RegisterScalableTarget
              - athena:*
              - batch:*
              - cloudformation:Describe*
              - cloudformation:Detect*
              - cloudformation:Estimate*
              - cloudformation:Get*
              - cloudformation:List*
              - cloudformation:Validate*
              - cloudfront:UpdateDistribution
              - cloudtrail:DescribeTrails
              - cloudtrail:CreateTrail
              - cloudwatch:*
              - codebuild:List*
              - cognito-idp:*
              - dynamodb:List*
              - ec2:*NetworkInterface*
              - ec2:AllocateAddress
              - ec2:AssociateRouteTable
              - ec2:AssociateSubnetCidrBlock
              - ec2:AssociateVpcCidrBlock
              - ec2:AttachInternetGateway
              - ec2:AuthorizeSecurityGroupEgress
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:CreateFlowLogs
              - ec2:CreateInternetGateway
              - ec2:CreateNatGateway
              - ec2:CreateRoute
              - ec2:CreateRouteTable
              - ec2:CreateSecurityGroup
              - ec2:CreateSubnet
              - ec2:CreateTags
              - ec2:CreateVpc
              - ec2:CreateVpcEndpoint
              - ec2:DeleteFlowLogs
              - ec2:DeleteInternetGateway
              - ec2:DeleteNatGateway
              - ec2:DeleteRoute
              - ec2:DeleteRouteTable
              - ec2:DeleteSecurityGroup
              - ec2:DeleteSubnet
              - ec2:DeleteTags
              - ec2:DeleteVpc
              - ec2:DeleteVpcEndpoint
              - ec2:DeleteVpcEndpoints
              - ec2:Describe*
              - ec2:DetachInternetGateway
              - ec2:DisassociateAddress
              - ec2:DisassociateRouteTable
              - ec2:DisassociateSubnetCidrBlock
              - ec2:DisassociateVpcCidrBlock
              - ec2:ModifyInstanceAttribute # Athena-to-Snowflake only
              - ec2:ModifySubnetAttribute
              - ec2:ModifyVpcAttribute
              - ec2:ModifyVpcEndpoint
              - ec2:ReleaseAddress
              - ec2:ReplaceRoute
              - ec2:ReplaceRouteTableAssociation
              - ec2:RevokeSecurityGroupEgress
              - ec2:RevokeSecurityGroupIngress
              - ec2:RunInstances # Athena-to-Snowflake only
              - ec2:StartInstances # Athena-to-Snowflake only
              - ec2:StopInstances # Athena-to-Snowflake only
              - ec2:TerminateInstances # Athena-to-Snowflake only
              - ec2:UpdateSecurityGroupRuleDescriptionsEgress
              - ec2:UpdateSecurityGroupRuleDescriptionsIngress
              - elasticfilesystem:ClientMount
              - elasticfilesystem:ClientRootAccess
              - elasticfilesystem:ClientWrite
              - elasticfilesystem:CreateAccessPoint
              - elasticfilesystem:CreateFileSystem
              - elasticfilesystem:CreateMountTarget
              - elasticfilesystem:DeleteAccessPoint
              - elasticfilesystem:DeleteFileSystem
              - elasticfilesystem:DeleteMountTarget
              - elasticfilesystem:DescribeAccessPoints
              - elasticfilesystem:DescribeFileSystems
              - elasticfilesystem:DescribeFileSystemPolicy
              - elasticfilesystem:DescribeLifecycleConfiguration
              - elasticfilesystem:DescribeMountTargets
              - elasticfilesystem:DescribeMountTargetSecurityGroups
              - elasticfilesystem:ModifyMountTargetSecurityGroups
              - elasticfilesystem:PutLifecycleConfiguration
              - elasticfilesystem:PutFileSystemPolicy
              - elasticfilesystem:ListTagsForResource
              - elasticfilesystem:TagResource
              - elasticfilesystem:UntagResource
              - elasticfilesystem:UpdateFileSystem
              - elasticloadbalancing:*
              - ecr:GetAuthorizationToken
              - ecs:*
              - events:*
              - firehose:ListDeliveryStreams
              - glue:*
              - guardduty:CreatePublishingDestination
              - guardduty:ListDetectors
              - kms:CreateKey
              - kms:List*
              - lambda:*EventSourceMapping
              - lambda:List*
              - logs:*
              - s3:ListAllMyBuckets
              - secretsmanager:Describe*
              - secretsmanager:List*
              - sns:List*
              - sqs:List*
              - states:CreateStateMachine
              - states:TagResource
              - states:UntagResource
            Resource: '*'
          - Effect: Allow
            Action: # permissions for handling self-onboarding CloudTrail
              - cloudtrail:AddTags
              - cloudtrail:DeleteTrail
              - cloudtrail:PutEventSelectors
              - cloudtrail:StartLogging
              - cloudtrail:StopLogging
              - cloudtrail:UpdateTrail
            Resource: !Sub arn:${AWS::Partition}:cloudtrail:*:${AWS::AccountId}:trail/panther-cloudtrail-*
          - Effect: Allow
            Action: cloudformation:*
            Resource:
              - !Sub arn:${AWS::Partition}:cloudformation:*:${AWS::AccountId}:stack/panther*
              - !Sub arn:${AWS::Partition}:cloudformation:*:${AWS::AccountId}:stackset/panther*
              - !Sub arn:${AWS::Partition}:cloudformation:*:aws:transform/Serverless-2016-10-31
          - Effect: Allow
            Action: codebuild:*
            Resource:
              - !Sub arn:${AWS::Partition}:codebuild:*:${AWS::AccountId}:project/panther-pulumi
              - !Sub arn:${AWS::Partition}:codebuild:*:${AWS::AccountId}:project/panther-pip-layer-builder
          - Effect: Allow # for ddb athena connector - can be removed once all deployments are 1.21+
            Action: serverlessrepo:*
            Resource: !Sub arn:${AWS::Partition}:serverlessrepo:*:*:applications/*
          - Effect: Allow # for ddb athena connector - can be removed once all deployments are 1.21+
            Action: s3:GetObject
            Resource: !Sub arn:${AWS::Partition}:s3:::awsserverlessrepo-changesets-*
          - Effect: Allow
            Action:
              # IMPORTANT: does *not* include access to table items
              - dynamodb:CreateTable
              - dynamodb:DeleteTable
              - dynamodb:Describe*
              - dynamodb:TagResource
              - dynamodb:UntagResource
              - dynamodb:UpdateContinuousBackups
              - dynamodb:UpdateTable
              - dynamodb:UpdateTimeToLive
            Resource: !Sub arn:${AWS::Partition}:dynamodb:*:${AWS::AccountId}:table/panther-*
          - Effect: Allow
            Action: firehose:*
            Resource: !Sub arn:${AWS::Partition}:firehose:*:${AWS::AccountId}:deliverystream/panther-*
          - Effect: Allow
            Action:
              - iam:AttachRolePolicy
              - iam:CreateRole
              - iam:DeleteRole
              - iam:DeleteRolePolicy
              - iam:DetachRolePolicy
              - iam:GetRole
              - iam:GetRolePolicy
              - iam:PassRole
              - iam:PutRolePolicy
              - iam:UpdateAssumeRolePolicy
              - iam:UpdateRole
              - iam:UpdateRoleDescription
              - iam:*ServerCertificate
              - iam:CreateServiceLinkedRole
              - iam:ListRoleTags
              - iam:TagRole
              - iam:UntagRole
            Resource:
              - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/AWSServiceRole*
              - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-service-role/*
              - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/panther-*
              - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/Panther*
              - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:server-certificate/panther/*
          - Effect: Allow
            Action:
              - iam:AddRoleToInstanceProfile # Athena-to-Snowflake only
              - iam:CreateInstanceProfile # Athena-to-Snowflake only
              - iam:DeleteInstanceProfile # Athena-to-Snowflake only
              - iam:RemoveRoleFromInstanceProfile # Athena-to-Snowflake only
            Resource:
              - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:instance-profile/Panther* # Athena-to-Snowflake only
              - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:instance-profile/panther-* # Athena-to-Snowflake only
          - Effect: Allow
            Action:
              - kms:CreateAlias
              - kms:Decrypt # required for KMS-encrypted S3 deployment assets (e.g. AWS::Lambda::LayerVersion)
              - kms:DeleteAlias
              - kms:DescribeKey
              - kms:DisableKeyRotation
              - kms:EnableKeyRotation
              - kms:GetKeyPolicy
              - kms:GetKeyRotationStatus
              - kms:ListResourceTags
              - kms:PutKeyPolicy
              - kms:ScheduleKeyDeletion
              - kms:TagResource
              - kms:UntagResource
              - kms:UpdateAlias
              - kms:UpdateKeyDescription
            Resource:
              - !Sub arn:${AWS::Partition}:kms:*:${AWS::AccountId}:alias/panther-*
              - !Sub arn:${AWS::Partition}:kms:*:${AWS::AccountId}:key/* # key ID is not known in advance
          - Effect: Allow
            Action:
              - lambda:GetLayerVersion
            Resource:
              - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:464622532012:layer:Datadog-Extension*
              - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:464622532012:layer:Datadog-Python*
          - Effect: Allow
            Action:
              # IMPORTANT: does *not* include lambda:InvokeFunction
              - lambda:AddLayerVersionPermission
              - lambda:AddPermission
              - lambda:CreateFunction
              - lambda:Delete*
              - lambda:Get*
              - lambda:PublishLayerVersion
              - lambda:Put*
              - lambda:RemoveLayerVersionPermission
              - lambda:RemovePermission
              - lambda:TagResource
              - lambda:UntagResource
              - lambda:Update*
            Resource:
              - !Sub arn:${AWS::Partition}:lambda:*:${AWS::AccountId}:event-source-mapping:*
              - !Sub arn:${AWS::Partition}:lambda:*:${AWS::AccountId}:function:panther-*
              - !Sub arn:${AWS::Partition}:lambda:*:${AWS::AccountId}:layer:panther-*
          - Effect: Allow
            Action: lambda:InvokeFunction
            Resource:
              - !Sub arn:${AWS::Partition}:lambda:*:${AWS::AccountId}:function:panther-cfn-custom-resources
              - !Sub arn:${AWS::Partition}:lambda:*:${AWS::AccountId}:function:panther-cfn-stack-policy
              - !Sub arn:${AWS::Partition}:lambda:*:${AWS::AccountId}:function:panther-pip-layer-builder
          - Effect: Allow
            Action:
              # IMPORTANT: does *not* include s3:GetObject
              - s3:CreateBucket
              - s3:DeleteBucket*
              - s3:GetBucket*
              - s3:Get*Configuration
              - s3:PutBucket*
              - s3:Put*Configuration
            Resource: !Sub arn:${AWS::Partition}:s3:::panther-*
          - Effect: Allow
            Action: s3:GetObject
            Resource:
              - !Sub arn:${AWS::Partition}:s3:::panther*-analysisversions-*/layers/* # for AWS::Lambda::LayerVersion
              # Release assets (Lambda binaries)
              - !Sub arn:${AWS::Partition}:s3:::panther-dev-sourcebucket-*
              - !Sub arn:${AWS::Partition}:s3:::panther-enterprise-*
          - Effect: Allow
            Action:
              - sns:AddPermission
              - sns:CreateTopic
              - sns:DeleteTopic
              - sns:GetTopicAttributes
              - sns:RemovePermission
              - sns:SetTopicAttributes
              - sns:Subscribe
              - sns:TagResource
              - sns:Unsubscribe
              - sns:UntagResource
            Resource: !Sub arn:${AWS::Partition}:sns:*:${AWS::AccountId}:panther-*
          - Effect: Allow
            Action:
              # IMPORTANT: does *not* include sqs:ReceiveMessage
              - sqs:AddPermission
              - sqs:CreateQueue
              - sqs:DeleteQueue
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SetQueueAttributes
              - sqs:TagQueue
              - sqs:UntagQueue
            Resource: !Sub arn:${AWS::Partition}:sqs:*:${AWS::AccountId}:panther-*
          - Effect: Allow
            Action: states:*
            Resource:
              - !Sub arn:${AWS::Partition}:states:*:${AWS::AccountId}:activity:panther-*
              - !Sub arn:${AWS::Partition}:states:*:${AWS::AccountId}:execution:panther-*:*
              - !Sub arn:${AWS::Partition}:states:*:${AWS::AccountId}:stateMachine:panther-*

Outputs:
  DeploymentRoleArn:
    Value: !GetAtt DeploymentRole.Arn
