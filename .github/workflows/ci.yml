on:
  push

permissions:
  contents: read  

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          disable-sudo: true
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            checkpoint-api.hashicorp.com:443
            files.pythonhosted.org:443
            github.com:443
            objects.githubusercontent.com:443
            pypi.org:443
            releases.hashicorp.com:443
      - name: Checkout
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29
      - name: Setup Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d
        with:
          python-version: 3.10.6
      - name: Install cfn-lint
        run: pip install cfn-lint
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@651471c36a6092792c552e8b1bef71e592b462d8
        with:
          terraform_version: 1.3.4
      - name: Setup tflint
        uses: terraform-linters/setup-tflint@19a52fbac37dacb22a09518e4ef6ee234f2d4987
      - name: Run terraform fmt
        run: terraform fmt -check -recursive ./terraform
      - name: Run tflint
        run: |
          pushd terraform
          tflint --recursive
          popd
      - name: Run cfn-lint
        run: cfn-lint -i W3045 -- cloudformation/*.yml
